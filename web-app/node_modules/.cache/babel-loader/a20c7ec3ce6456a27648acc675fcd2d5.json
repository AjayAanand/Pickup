{"ast":null,"code":"import{FETCH_TASKS,FETCH_TASKS_SUCCESS,FETCH_TASKS_FAILED,ACCEPT_TASK,CANCEL_TASK}from\"../store/types\";import store from\"../store/store\";import{updateProfile}from\"./authactions\";import{RequestPushMsg}from\"../other/NotificationFunctions\";import{firebase}from'../config/configureFirebase';import{onValue,runTransaction,get,off,push}from\"firebase/database\";import{driverQueue}from'../other/sharedFunctions';export var fetchTasks=function fetchTasks(){return function(dispatch){var auth=firebase.auth,tasksRef=firebase.tasksRef;var uid=auth.currentUser.uid;off(tasksRef());dispatch({type:FETCH_TASKS,payload:null});onValue(tasksRef(),function(snapshot){if(snapshot.val()){var data=snapshot.val();var arr=Object.keys(data).filter(function(i){return data[i].requestedDrivers&&data[i].requestedDrivers[uid];}).map(function(i){data[i].id=i;return data[i];});dispatch({type:FETCH_TASKS_SUCCESS,payload:arr});}else{dispatch({type:FETCH_TASKS_FAILED,payload:store.getState().languagedata.defaultLanguage.no_tasks});}});};};export var acceptTask=function acceptTask(task){return function(dispatch){var auth=firebase.auth,trackingRef=firebase.trackingRef,singleUserRef=firebase.singleUserRef,singleBookingRef=firebase.singleBookingRef;var uid=auth.currentUser.uid;onValue(singleUserRef(uid),function(snapshot){var profile=snapshot.val();runTransaction(singleBookingRef(task.id),function(booking){if(booking&&booking.requestedDrivers){booking.driver=uid;booking.driver_image=profile.profile_image?profile.profile_image:\"\";booking.car_image=profile.car_image?profile.car_image:\"\";booking.driver_name=profile.firstName+\" \"+profile.lastName;booking.driver_contact=profile.mobile;booking.driver_token=profile.pushToken?profile.pushToken:'';booking.vehicle_number=profile.vehicleNumber?profile.vehicleNumber:\"\";booking.driverRating=profile.rating?profile.rating:\"0\";booking.fleetadmin=profile.fleetadmin?profile.fleetadmin:\"\";booking.status=\"ACCEPTED\";booking.driverDeviceId=task.driverDeviceId?task.driverDeviceId:null;booking.requestedDrivers=null;booking.driverEstimates=null;return booking;}}).then(function(){get(singleBookingRef(task.id)).then(function(snapshot){if(!snapshot.exists()){return;}else{var requestedDrivers=snapshot.val()&&snapshot.val().requestedDrivers;var driverId=snapshot.val()&&snapshot.val().driver;if(requestedDrivers==undefined&&driverId===uid){updateProfile({queue:driverQueue?false:true})(dispatch);RequestPushMsg(task.customer_token,{title:store.getState().languagedata.defaultLanguage.notification_title,msg:profile.firstName+store.getState().languagedata.defaultLanguage.accept_booking_request,screen:\"BookedCab\",params:{bookingId:task.id}});var driverLocation=store.getState().gpsdata.location;push(trackingRef(task.id),{at:new Date().getTime(),status:\"ACCEPTED\",lat:driverLocation.lat,lng:driverLocation.lng});dispatch({type:ACCEPT_TASK,payload:{task:task}});}}}).catch(function(error){console.error(error);});});},{onlyOnce:true});};};export var cancelTask=function cancelTask(bookingId){return function(dispatch){var auth=firebase.auth,singleBookingRef=firebase.singleBookingRef;var uid=auth.currentUser.uid;runTransaction(singleBookingRef(bookingId),function(booking){if(booking&&booking.requestedDrivers){if(booking.requestedDrivers!==null&&Object.keys(booking.requestedDrivers).length===1){booking.status=\"NEW\";booking.requestedDrivers=null;booking.driverEstimates=null;RequestPushMsg(booking.customer_token,{title:store.getState().languagedata.defaultLanguage.notification_title,msg:store.getState().languagedata.defaultLanguage.booking_cancelled+bookingId,screen:\"BookedCab\",params:{bookingId:bookingId}});dispatch({type:CANCEL_TASK,payload:{uid:uid,bookingId:bookingId}});}else{delete booking.requestedDrivers[uid];}if(booking.driverOffers&&booking.driverOffers[uid]){delete booking.driverOffers[uid];}if(booking.selectedBid&&booking.selectedBid.driver===uid){delete booking.selectedBid;}return booking;}});};};","map":{"version":3,"names":["FETCH_TASKS","FETCH_TASKS_SUCCESS","FETCH_TASKS_FAILED","ACCEPT_TASK","CANCEL_TASK","store","updateProfile","RequestPushMsg","firebase","onValue","runTransaction","get","off","push","driverQueue","fetchTasks","dispatch","auth","tasksRef","uid","currentUser","type","payload","snapshot","val","data","arr","Object","keys","filter","i","requestedDrivers","map","id","getState","languagedata","defaultLanguage","no_tasks","acceptTask","task","trackingRef","singleUserRef","singleBookingRef","profile","booking","driver","driver_image","profile_image","car_image","driver_name","firstName","lastName","driver_contact","mobile","driver_token","pushToken","vehicle_number","vehicleNumber","driverRating","rating","fleetadmin","status","driverDeviceId","driverEstimates","then","exists","driverId","undefined","queue","customer_token","title","notification_title","msg","accept_booking_request","screen","params","bookingId","driverLocation","gpsdata","location","at","Date","getTime","lat","lng","catch","error","console","onlyOnce","cancelTask","length","booking_cancelled","driverOffers","selectedBid"],"sources":["/Users/sumitbajaj/Downloads/TAXI-PICK/Sourcecode/common/src/actions/taskactions.js"],"sourcesContent":["import {\r\n  FETCH_TASKS,\r\n  FETCH_TASKS_SUCCESS,\r\n  FETCH_TASKS_FAILED,\r\n  ACCEPT_TASK,\r\n  CANCEL_TASK,\r\n} from \"../store/types\";\r\nimport store from \"../store/store\";\r\nimport { updateProfile } from \"./authactions\";\r\nimport { RequestPushMsg } from \"../other/NotificationFunctions\";\r\nimport { firebase } from '../config/configureFirebase';\r\nimport { onValue, runTransaction, get, off, push } from \"firebase/database\";\r\nimport {driverQueue} from '../other/sharedFunctions';\r\n\r\nexport const fetchTasks = () => (dispatch) => {\r\n  const { auth, tasksRef } = firebase;\r\n\r\n  const uid = auth.currentUser.uid;\r\n  off(tasksRef());\r\n  dispatch({\r\n    type: FETCH_TASKS,\r\n    payload: null,\r\n  });\r\n  onValue(tasksRef(), (snapshot) => {\r\n    if (snapshot.val()) {\r\n      let data = snapshot.val();\r\n      const arr = Object.keys(data)\r\n        .filter(\r\n          (i) => data[i].requestedDrivers && data[i].requestedDrivers[uid]\r\n        )\r\n        .map((i) => {\r\n          data[i].id = i;\r\n          return data[i];\r\n        });\r\n      dispatch({\r\n        type: FETCH_TASKS_SUCCESS,\r\n        payload: arr,\r\n      });\r\n    } else {\r\n      dispatch({\r\n        type: FETCH_TASKS_FAILED,\r\n        payload: store.getState().languagedata.defaultLanguage.no_tasks,\r\n      });\r\n    }\r\n  });\r\n};\r\n\r\nexport const acceptTask = (task) => (dispatch) => {\r\n  const { auth, trackingRef, singleUserRef, singleBookingRef } = firebase;\r\n\r\n  const uid = auth.currentUser.uid;\r\n\r\n  onValue(singleUserRef(uid), (snapshot) => {\r\n    let profile = snapshot.val();\r\n\r\n    runTransaction(singleBookingRef(task.id),(booking) => {\r\n        if (booking && booking.requestedDrivers) {\r\n          booking.driver = uid;\r\n          booking.driver_image = profile.profile_image ? profile.profile_image : \"\";\r\n          booking.car_image =  profile.car_image ? profile.car_image : \"\";\r\n          booking.driver_name = profile.firstName + \" \" + profile.lastName;\r\n          booking.driver_contact = profile.mobile;\r\n          booking.driver_token = profile.pushToken ? profile.pushToken : '';\r\n          booking.vehicle_number = profile.vehicleNumber ? profile.vehicleNumber : \"\";\r\n          booking.driverRating = profile.rating ? profile.rating : \"0\";\r\n          booking.fleetadmin = profile.fleetadmin ? profile.fleetadmin : \"\";\r\n          booking.status = \"ACCEPTED\";\r\n          booking.driverDeviceId = task.driverDeviceId? task.driverDeviceId: null;\r\n          booking.requestedDrivers = null;\r\n          booking.driverEstimates = null;\r\n          return booking;\r\n        }\r\n      })\r\n      .then(() => {\r\n        get(singleBookingRef(task.id))\r\n          .then((snapshot) => {\r\n            if (!snapshot.exists()) {\r\n              return;\r\n            } else {\r\n              let requestedDrivers =\r\n                snapshot.val() && snapshot.val().requestedDrivers;\r\n              let driverId = snapshot.val() && snapshot.val().driver;\r\n\r\n              if (requestedDrivers == undefined && driverId === uid) {\r\n                updateProfile({ queue: driverQueue ? false : true })(dispatch);\r\n                RequestPushMsg(task.customer_token, {\r\n                  title:\r\n                    store.getState().languagedata.defaultLanguage\r\n                      .notification_title,\r\n                  msg:\r\n                   profile.firstName +\r\n                    store.getState().languagedata.defaultLanguage\r\n                      .accept_booking_request,\r\n                  screen: \"BookedCab\",\r\n                  params: { bookingId: task.id },\r\n                });\r\n\r\n                const driverLocation = store.getState().gpsdata.location;\r\n\r\n                push(trackingRef(task.id), {\r\n                  at: new Date().getTime(),\r\n                  status: \"ACCEPTED\",\r\n                  lat: driverLocation.lat,\r\n                  lng: driverLocation.lng,\r\n                });\r\n\r\n                dispatch({\r\n                  type: ACCEPT_TASK,\r\n                  payload: { task: task },\r\n                });\r\n              }\r\n            }\r\n          })\r\n          .catch((error) => {\r\n            console.error(error);\r\n          });\r\n      });\r\n  },{onlyOnce:true});\r\n};\r\n\r\nexport const cancelTask = (bookingId) => (dispatch) => {\r\n  const { auth, singleBookingRef } = firebase;\r\n\r\n  const uid = auth.currentUser.uid;\r\n\r\n  runTransaction(singleBookingRef(bookingId), (booking) => {\r\n      if (booking && booking.requestedDrivers) {\r\n        if (\r\n          booking.requestedDrivers !== null &&\r\n          Object.keys(booking.requestedDrivers).length === 1\r\n        ) {\r\n          booking.status = \"NEW\";\r\n          booking.requestedDrivers = null;\r\n          booking.driverEstimates = null;\r\n          RequestPushMsg(booking.customer_token, {\r\n            title:\r\n              store.getState().languagedata.defaultLanguage.notification_title,\r\n            msg:\r\n              store.getState().languagedata.defaultLanguage.booking_cancelled +\r\n              bookingId,\r\n            screen: \"BookedCab\",\r\n            params: { bookingId: bookingId },\r\n          });\r\n          dispatch({\r\n            type: CANCEL_TASK,\r\n            payload: { uid: uid, bookingId: bookingId },\r\n          });\r\n        }else{\r\n          delete booking.requestedDrivers[uid];\r\n        }\r\n        if(booking.driverOffers && booking.driverOffers[uid]){\r\n          delete booking.driverOffers[uid];\r\n        }\r\n        if(booking.selectedBid && booking.selectedBid.driver === uid){\r\n          delete booking.selectedBid;\r\n        }\r\n        return booking;\r\n      }\r\n    });\r\n};\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}